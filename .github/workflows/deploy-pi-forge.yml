name: Deploy to Pi-Forge (Local Development)

on:
  push:
    branches: [develop]
  workflow_dispatch:

env:
  NODE_VERSION: '18'
  DEPLOY_PATH: /deployments/jpstas.com

jobs:
  build-and-deploy:
    name: Build and Deploy to Pi-Forge
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify Node.js
        run: |
          echo "Node.js: $(node --version)"
          echo "NPM: $(npm --version)"

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL || '' }}

      - name: Deploy to Pi-Forge
        run: |
          echo "ðŸš€ Deploying to Pi-Forge..."

          # Create deployment directory if it doesn't exist
          mkdir -p ${{ env.DEPLOY_PATH }}

          # Backup previous deployment
          if [ -d "${{ env.DEPLOY_PATH }}/current" ]; then
            echo "ðŸ“¦ Backing up previous deployment..."
            rm -rf ${{ env.DEPLOY_PATH }}/backup
            mv ${{ env.DEPLOY_PATH }}/current ${{ env.DEPLOY_PATH }}/backup
          fi

          # Deploy new build
          echo "ðŸ“‚ Copying new build..."
          mkdir -p ${{ env.DEPLOY_PATH }}/current
          cp -r dist/* ${{ env.DEPLOY_PATH }}/current/

          # Set permissions
          chmod -R 755 ${{ env.DEPLOY_PATH }}/current

          echo "âœ… Deployment complete!"
          echo "ðŸ“ Site location: ${{ env.DEPLOY_PATH }}/current"

      - name: Verify deployment
        run: |
          if [ -f "${{ env.DEPLOY_PATH }}/current/index.html" ]; then
            echo "âœ… Deployment verified - index.html exists"
          else
            echo "âŒ Deployment failed - index.html not found"
            exit 1
          fi

      - name: Deployment summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Deployment successful to Pi-Forge!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Server**: pi-forge (192.168.50.157)" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: http://192.168.50.157:8000" >> $GITHUB_STEP_SUMMARY
          echo "- **Path**: ${{ env.DEPLOY_PATH }}/current" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
